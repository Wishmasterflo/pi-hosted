#!/bin/bash                                                                                                                                                                                                          
                                                                                                                                                                                                                     
function error() {                                                                                                                                                                                                   
  echo -e "\\e[91m$1\\e[39m"                                                                                                                                                                                         
  exit 1                                                                                                                                                                                                             
}                                                                                                                                                                                                                    
                                                                                                                                                                                                                     
function check_internet() {                                                                                                                                                                                          
  printf "Checking if you are online..."                                                                                                                                                                             
  wget -q --spider http://github.com                                                                                                                                                                                 
  if [ $? -eq 0 ]; then                                                                                                                                                                                              
    echo "Online. Continuing."                                                                                                                                                                                       
  else                                                                                                                                                                                                               
    error "Offline. Go connect to the internet then run the script again."                                                                                                                                           
  fi                                                                                                                                                                                                                 
}                                                                                                                                                                                                                    
                                                                                                                                                                                                                     
check_internet                                                                                                                                                                                                       
                                                                                                                                                                                                                     
portainer_pid=`podman ps | grep portainer-ce | awk '{print $1}'`                                                                                                                                                     
portainer_name=`podman ps | grep portainer-ce | awk '{print $2}'`                                                                                                                                                    
                                                                                                                                                                                                                     
sudo podman stop $portainer_pid || error "Failed to stop portainer!"                                                                                                                                                 
sudo podman rm $portainer_pid || error "Failed to remove portainer container!"                                                                                                                                       
sudo podman rmi $portainer_name || error "Failed to remove/untag images from the container!"                                                                                                                         
                                                                                                                                                                                                                     
sudo mkdir -p /portainer/Config/portainer || error "Failed to create the Portainer Config Folder"                                                                                                                    
chown flo:flo /portainer/Config/portainer                                                                                                                                                                                                                     
podman run -d -p 9443:9443 --pid=host --privileged --name portainer --restart=always -v /run/user/$UID/podman/podman.sock:/var/run/docker.sock:Z -v /portainer/Config/portainer:/data docker.io/portainer/portainer-c
e:latest                                                                                                                                                                                                             
export DOCKER_HOST=unix:///run/user/$UID/podman/podman.sock                                                                                                                                                          
systemctl --user start --now podman.socket                                                                                                                                                                           
systemctl --user status --now podman.socket                                                                                                                                                                          
echo " "                                                                                                                                                                                                             
podman ps -all                                                                                                                                                                                                       
